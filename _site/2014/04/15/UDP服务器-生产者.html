<!doctype html>
<html>
<head>
  <meta charset="utf-8">
<title>UDP服务器 生产者 | 落枫的博客</title>
<meta name="author" content="">

  <meta name="keywords" content="linux">


<link rel="shortcut icon" href="/public/upload/gavatar/favicon.ico" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="/public/css/bootstrap.css">
<link rel="stylesheet" href="/public/css/font-awesome.css">
<link rel="stylesheet" href="/public/js/prettify/prettify.css">
<link rel="stylesheet" href="/public/css/base.css">
<!--<link href="/pages/atom.xml" rel="alternate" title="落枫的博客" type="application/atom+xml"> -->
</head>
<body>
  <div class="container">
    <div class="row">
      <div class="col-md-4 col-lg-4 col-sm-12 col-xs-12 aside visible-md visible-lg">
  <div class="row">
    <div class="col-md-3 col-xs-3 aside1">
      <br>
      <a class="pjaxlink" href="/"><img src="/public/upload/gavatar/gavatar.png" class="img-rounded avatar"></a>
      <br><br>
      <ul class="nav nav-pills nav-stacked">
        
          <li><a href="#学习" data-toggle="tab">学习</a></li>
        
        <li><a href="#tags" data-toggle="tab">标签</a></li>
        <!--        <li><a class="pjaxlink" href="/pages/about.html">关于</a></li>-->
      </ul>
      <div class="aside1_bottom">
        <!--
        <table class="table table-condensed">
          <tr>
            <td><a href="/pages/atom.xml" target="_blank"><i class="fa fa-rss fa-2x"></i></a></td>
            <td><a href="mailto:liuwenyu21@gmail.com"><i class="fa fa-envelope-o fa-2x"></i></a></td>
          </tr>
        </table>
      -->
        <!--
      <img src="" class="img-rounded weixin">
      -->
      </div>
    </div>
    <div class="col-md-9 col-xs-9 aside2">
      <div class="row">
        <div class="tab-content">
           
            <div class="tab-pane" id="学习">
              <div class="list-group">
                <h2 class="center">学习</h2>
                
                  <a href="/2014/04/16/%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F.html" class="list-group-item pjaxlink">工厂模式</a>
                
                  <a href="/2014/04/15/UDP%E6%9C%8D%E5%8A%A1%E5%99%A8-%E7%94%9F%E4%BA%A7%E8%80%85.html" class="list-group-item pjaxlink">UDP服务器 生产者</a>
                
                  <a href="/2014/04/14/%E7%BA%BF%E7%A8%8B.html" class="list-group-item pjaxlink">线程</a>
                
                  <a href="/2014/04/04/Socket%20TCP.html" class="list-group-item pjaxlink">Socket TCP</a>
                
                  <a href="/2014/04/03/linux(UDP).html" class="list-group-item pjaxlink">基于UDP的多人群聊</a>
                
                  <a href="/2014/04/02/Linux(socket%20UDP).html" class="list-group-item pjaxlink">Linux网络编程 socket UDP</a>
                
                  <a href="/2014/04/01/Linux(%20big%20endian-little%20endian%20-ip%20conversion).html" class="list-group-item pjaxlink">大端小端 ip转换</a>
                
                  <a href="/2014/03/31/pthread.html" class="list-group-item pjaxlink">pthread</a>
                
              </div>
            </div>
          
          <div class="tab-pane" id="tags">
            <div class="panel-group" id="accordion">
              <h2 class="center">标签</h2>
               
                <div class="panel panel-info">
                  <div class="panel-heading">
                    <h4 class="panel-title">
                      <a data-toggle="collapse" data-toggle="collapse" data-parent="#accordion" href="#linux">linux</a>
                      <span class="badge pull-right">8</span>
                    </h4>
                  </div>
                  <div id="linux" class="panel-collapse collapse">
                    
                      <a  href='/2014/04/16/%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F.html' class="list-group-item pjaxlink">
                        工厂模式
                      </a>
                    
                      <a  href='/2014/04/15/UDP%E6%9C%8D%E5%8A%A1%E5%99%A8-%E7%94%9F%E4%BA%A7%E8%80%85.html' class="list-group-item pjaxlink">
                        UDP服务器 生产者
                      </a>
                    
                      <a  href='/2014/04/14/%E7%BA%BF%E7%A8%8B.html' class="list-group-item pjaxlink">
                        线程
                      </a>
                    
                      <a  href='/2014/04/04/Socket%20TCP.html' class="list-group-item pjaxlink">
                        Socket TCP
                      </a>
                    
                      <a  href='/2014/04/03/linux(UDP).html' class="list-group-item pjaxlink">
                        基于UDP的多人群聊
                      </a>
                    
                      <a  href='/2014/04/02/Linux(socket%20UDP).html' class="list-group-item pjaxlink">
                        Linux网络编程 socket UDP
                      </a>
                    
                      <a  href='/2014/04/01/Linux(%20big%20endian-little%20endian%20-ip%20conversion).html' class="list-group-item pjaxlink">
                        大端小端 ip转换
                      </a>
                    
                      <a  href='/2014/03/31/pthread.html' class="list-group-item pjaxlink">
                        pthread
                      </a>
                    
                  </div>
                </div>
              
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

      <div class="col-md-8 col-lg-8 col-sm-12 col-xs-12 aside3">
        <div id="container">
          <div id="pjax">
            <div class="row">
  <div class="col-md-12 aside3-title">
    <br>
    <h2 id="#identifier">UDP服务器 生产者</h2>
    2014年04月15日
  </div>
  <div class="col-md-12 aside3-content">
    <hr>
    <div id="content">
      <h2>UDP服务器</h2>

<p>代码：</p>

<h2>UDPServer.h</h2>

<div class="highlight"><pre><code class="c--"><span class="cp">#ifndef UDPSERVER_H_</span>
<span class="cp">#define UDPSERVER_H_</span>

<span class="cp">#include &lt;iostream&gt;</span>
<span class="cp">#include &lt;sys/socket.h&gt;</span>
<span class="cp">#include &lt;arpa/inet.h&gt;</span>
<span class="cp">#include &lt;unistd.h&gt;</span>
<span class="cp">#include &lt;netinet/in.h&gt;</span>
<span class="cp">#include &lt;stdexcept&gt;</span>
<span class="cp">#include &lt;string&gt;</span>
<span class="cp">#include &lt;string.h&gt;</span>

<span class="k">class</span> <span class="nc">UDPServer</span> <span class="p">{</span>
<span class="nl">public:</span>
        <span class="n">UDPServer</span><span class="p">(</span><span class="kt">int</span> <span class="n">port</span><span class="p">);</span>    <span class="c1">//create socket  &amp;&amp;  bind</span>
        <span class="k">virtual</span> <span class="o">~</span><span class="n">UDPServer</span><span class="p">();</span>   <span class="c1">//close socket</span>

        <span class="c1">//recv</span>
        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">receive</span><span class="p">();</span>
        <span class="c1">//send</span>
        <span class="kt">void</span> <span class="nf">send</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="p">);</span>

<span class="nl">private:</span>
        <span class="kt">int</span> <span class="n">_fd</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">_server_addr</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">_port</span><span class="p">;</span>

        <span class="kt">void</span> <span class="nf">_bind</span><span class="p">();</span>

        <span class="c1">//</span>
        <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">_client_addr</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#endif </span><span class="cm">/* UDPSERVER_H_ */</span><span class="cp"></span></code></pre></div>

<h2>UDPServer.cpp</h2>

<div class="highlight"><pre><code class="c--"><span class="cm">/*</span>
<span class="cm"> * UDPServer.cpp</span>
<span class="cm"> *</span>
<span class="cm"> *  Created on: Apr 15, 2014</span>
<span class="cm"> *      Author: liuwenyu</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;UDPServer.h&quot;</span>

<span class="n">UDPServer</span><span class="o">::</span><span class="n">UDPServer</span><span class="p">(</span><span class="kt">int</span> <span class="n">port</span><span class="p">)</span> <span class="o">:</span>
                <span class="n">_port</span><span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>

        <span class="n">_fd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_DGRAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

        <span class="n">_bind</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">UDPServer</span><span class="o">::</span><span class="n">_bind</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">_server_addr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
        <span class="n">_server_addr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">_port</span><span class="p">);</span>
        <span class="n">_server_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">INADDR_ANY</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">bind</span><span class="p">(</span><span class="n">_fd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span><span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">_server_addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">_server_addr</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;bind port fail!&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">UDPServer</span><span class="o">::~</span><span class="n">UDPServer</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">close</span><span class="p">(</span><span class="n">_fd</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">UDPServer</span><span class="o">::</span><span class="n">receive</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">_client_addr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
        <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">_client_addr</span><span class="p">);</span>
        <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">SIZE</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>
        <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">SIZE</span><span class="p">];</span>
        <span class="kt">int</span> <span class="n">n_read</span> <span class="o">=</span> <span class="n">recvfrom</span><span class="p">(</span><span class="n">_fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">SIZE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span><span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">_client_addr</span><span class="p">,</span>
                        <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
        <span class="n">buf</span><span class="p">[</span><span class="n">n_read</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">buf</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">UDPServer</span><span class="o">::</span><span class="n">send</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">s</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">_client_addr</span><span class="p">);</span>
        <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">SIZE</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>
        <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">SIZE</span><span class="p">];</span>
        <span class="n">strcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
        <span class="kt">int</span> <span class="n">n_send</span> <span class="o">=</span> <span class="n">sendto</span><span class="p">(</span><span class="n">_fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span><span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">_client_addr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">n_send</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;send error!&quot;</span><span class="p">);</span>
<span class="p">}</span></code></pre></div>

<h2>生产者消费者</h2>

<h2>C语言风格版</h2>

<div class="highlight"><pre><code class="c--"><span class="cp">#include &lt;iostream&gt;</span>
<span class="cp">#include &lt;pthread.h&gt;</span>
<span class="cp">#include &lt;string&gt;</span>
<span class="cp">#include &lt;queue&gt;</span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>

<span class="n">std</span><span class="o">::</span><span class="n">queue</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span>   <span class="n">Q</span><span class="p">;</span>
<span class="kt">pthread_mutex_t</span> <span class="n">mutex</span><span class="p">;</span>
<span class="kt">pthread_cond_t</span> <span class="n">cond</span><span class="p">;</span>

<span class="kt">void</span> <span class="o">*</span><span class="nf">producer_func</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
        <span class="c1">// produce sth</span>
        <span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
        <span class="n">Q</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;push a number&quot;</span><span class="p">;</span>
        <span class="n">pthread_cond_signal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cond</span><span class="p">);</span>
        <span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>

        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="o">*</span><span class="nf">consumer_func</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
        <span class="c1">// consume</span>
        <span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>

        <span class="k">while</span><span class="p">(</span><span class="n">Q</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
                <span class="n">pthread_cond_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cond</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
        <span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="n">Q</span><span class="p">.</span><span class="n">front</span><span class="p">();</span>
        <span class="n">Q</span><span class="p">.</span><span class="n">pop</span><span class="p">();</span>
        <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;get a num: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">num</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>

        <span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pthread_mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
        <span class="n">pthread_cond_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cond</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span></code></pre></div>

<h2>利用面向对象思想重写生产者消费者问题</h2>

<p>MutexLock.h</p>

<div class="highlight"><pre><code class="c--"><span class="cm">/*</span>
<span class="cm"> * MutexLock.h</span>
<span class="cm"> *</span>
<span class="cm"> *  Created on: Apr 14, 2014</span>
<span class="cm"> *      Author: liuwenyu</span>
<span class="cm"> */</span>

<span class="cp">#ifndef MUTEXLOCK_H_</span>
<span class="cp">#define MUTEXLOCK_H_</span>

<span class="cp">#include &lt;pthread.h&gt;</span>
<span class="k">class</span> <span class="nc">Condition</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm"> * init</span>
<span class="cm"> * destroy</span>
<span class="cm"> * lock</span>
<span class="cm"> * unlock</span>
<span class="cm"> */</span>
<span class="k">class</span> <span class="nc">MutexLock</span> <span class="p">{</span>
    <span class="k">friend</span> <span class="k">class</span> <span class="nc">Condition</span><span class="p">;</span>
<span class="nl">public:</span>
    <span class="n">MutexLock</span><span class="p">();</span>
    <span class="k">virtual</span> <span class="o">~</span><span class="n">MutexLock</span><span class="p">();</span>

    <span class="kt">void</span> <span class="nf">lock</span><span class="p">();</span>
    <span class="kt">void</span> <span class="nf">unlock</span><span class="p">();</span>
<span class="nl">private:</span>
    <span class="kt">pthread_mutex_t</span> <span class="n">_mutex</span><span class="p">;</span>
<span class="p">};</span>
<span class="cp">#endif </span><span class="cm">/* MUTEXLOCK_H_ */</span><span class="cp"></span></code></pre></div>

<p>MutexLock.cpp</p>

<div class="highlight"><pre><code class="c--"><span class="cm">/*</span>
<span class="cm"> * MutexLock.cpp</span>
<span class="cm"> *</span>
<span class="cm"> *  Created on: Apr 14, 2014</span>
<span class="cm"> *      Author: liuwenyu</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;MutexLock.h&quot;</span>
<span class="cp">#include &lt;stdexcept&gt;</span>
<span class="cp">#include &quot;Condition.h&quot;</span>

<span class="n">MutexLock</span><span class="o">::</span><span class="n">MutexLock</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// TODO Auto-generated constructor stub</span>
    <span class="k">if</span><span class="p">(</span><span class="n">pthread_mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_mutex</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;Init lock fail!!&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">MutexLock</span><span class="o">::~</span><span class="n">MutexLock</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// TODO Auto-generated destructor stub</span>
    <span class="n">pthread_mutex_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_mutex</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="n">MutexLock</span><span class="o">::</span><span class="n">lock</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">MutexLock</span><span class="o">::</span><span class="n">unlock</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_mutex</span><span class="p">);</span>
<span class="p">}</span></code></pre></div>

<h2>Condition.h</h2>

<div class="highlight"><pre><code class="c--"><span class="cm">/*</span>
<span class="cm"> * Condition.h</span>
<span class="cm"> *</span>
<span class="cm"> *  Created on: Apr 14, 2014</span>
<span class="cm"> *      Author: liuwenyu</span>
<span class="cm"> */</span>

<span class="cp">#ifndef CONDITION_H_</span>
<span class="cp">#define CONDITION_H_</span>

<span class="cp">#include &lt;pthread.h&gt;</span>
<span class="cp">#include &quot;MutexLock.h&quot;</span>

<span class="k">class</span> <span class="nc">Condition</span> <span class="p">{</span>
<span class="nl">public:</span>
    <span class="n">Condition</span><span class="p">(</span><span class="n">MutexLock</span> <span class="o">*</span><span class="n">p_lock</span><span class="p">);</span>
    <span class="k">virtual</span> <span class="o">~</span><span class="n">Condition</span><span class="p">();</span>

    <span class="kt">void</span> <span class="nf">wait</span><span class="p">();</span>

    <span class="kt">void</span> <span class="nf">notify</span><span class="p">();</span>    <span class="c1">//signal</span>
    <span class="kt">void</span> <span class="nf">notifyAll</span><span class="p">();</span> <span class="c1">//broadcast</span>

<span class="nl">private:</span>
    <span class="kt">pthread_cond_t</span> <span class="n">_cond</span><span class="p">;</span>

    <span class="c1">//bind</span>
    <span class="n">MutexLock</span> <span class="o">*</span><span class="n">_p_lock</span><span class="p">;</span>

<span class="p">};</span>

<span class="cp">#endif </span><span class="cm">/* CONDITION_H_ */</span><span class="cp"></span></code></pre></div>

<h2>Condition.cpp</h2>

<div class="highlight"><pre><code class="c--"><span class="cm">/*</span>
<span class="cm"> * Condition.cpp</span>
<span class="cm"> *</span>
<span class="cm"> *  Created on: Apr 14, 2014</span>
<span class="cm"> *      Author: liuwenyu</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;Condition.h&quot;</span>
<span class="cp">#include &lt;stdexcept&gt;</span>

<span class="n">Condition</span><span class="o">::</span><span class="n">Condition</span><span class="p">(</span><span class="n">MutexLock</span> <span class="o">*</span><span class="n">p_lock</span><span class="p">)</span> <span class="o">:</span>
        <span class="n">_p_lock</span><span class="p">(</span><span class="n">p_lock</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// TODO Auto-generated constructor stub</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pthread_cond_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_cond</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;Init condition fail!&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">Condition</span><span class="o">::~</span><span class="n">Condition</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// TODO Auto-generated destructor stub</span>
    <span class="n">pthread_cond_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_cond</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Condition</span><span class="o">::</span><span class="n">wait</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">pthread_cond_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_cond</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">_p_lock</span><span class="o">-&gt;</span><span class="n">_mutex</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Condition</span><span class="o">::</span><span class="n">notify</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">pthread_cond_signal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_cond</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Condition</span><span class="o">::</span><span class="n">notifyAll</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">pthread_cond_broadcast</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_cond</span><span class="p">);</span>
<span class="p">}</span></code></pre></div>

<h3>WorkingQueue.h</h3>

<div class="highlight"><pre><code class="c--"><span class="cm">/*</span>
<span class="cm"> * WorkingQueue.h</span>
<span class="cm"> *</span>
<span class="cm"> *  Created on: Apr 15, 2014</span>
<span class="cm"> *      Author: liuwenyu</span>
<span class="cm"> */</span>

<span class="cp">#ifndef WORKINGQUEUE_H_</span>
<span class="cp">#define WORKINGQUEUE_H_</span>

<span class="cp">#include &lt;queue&gt;</span>
<span class="cp">#include &quot;MutexLock.h&quot;</span>
<span class="cp">#include &quot;Condition.h&quot;</span>

<span class="k">class</span> <span class="nc">WorkingQueue</span> <span class="p">{</span>
<span class="nl">public:</span>
    <span class="n">WorkingQueue</span><span class="p">();</span>
    <span class="k">virtual</span> <span class="o">~</span><span class="n">WorkingQueue</span><span class="p">();</span>

    <span class="kt">int</span> <span class="nf">consume</span><span class="p">();</span>
    <span class="kt">void</span> <span class="nf">product</span><span class="p">(</span><span class="kt">int</span> <span class="n">num</span><span class="p">);</span>

<span class="nl">private:</span>
    <span class="n">std</span><span class="o">::</span><span class="n">queue</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">_queue</span><span class="p">;</span>
    <span class="n">MutexLock</span> <span class="n">_lock</span><span class="p">;</span>
    <span class="n">Condition</span> <span class="n">_cond</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#endif </span><span class="cm">/* WORKINGQUEUE_H_ */</span><span class="cp"></span></code></pre></div>

<h3>WorkingQueue.cpp</h3>

<div class="highlight"><pre><code class="c--"><span class="cm">/*</span>
<span class="cm"> * WorkingQueue.cpp</span>
<span class="cm"> *</span>
<span class="cm"> *  Created on: Apr 15, 2014</span>
<span class="cm"> *      Author: liuwenyu</span>
<span class="cm"> */</span>
<span class="cp">#include &quot;WorkingQueue.h&quot;</span>
<span class="cp">#include &lt;stdlib.h&gt;</span>
<span class="cp">#include &lt;unistd.h&gt;</span>

<span class="n">WorkingQueue</span><span class="o">::</span><span class="n">WorkingQueue</span><span class="p">()</span> <span class="o">:</span>
        <span class="n">_queue</span><span class="p">(),</span> <span class="n">_lock</span><span class="p">(),</span> <span class="n">_cond</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_lock</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// TODO Auto-generated constructor stub</span>
    <span class="n">srand</span><span class="p">(</span><span class="mi">10086</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">WorkingQueue</span><span class="o">::~</span><span class="n">WorkingQueue</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// TODO Auto-generated destructor stub</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">WorkingQueue</span><span class="o">::</span><span class="n">consume</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">_lock</span><span class="p">.</span><span class="n">lock</span><span class="p">();</span>
    <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">_queue</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">_cond</span><span class="p">.</span><span class="n">wait</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">_queue</span><span class="p">.</span><span class="n">front</span><span class="p">();</span>
    <span class="n">_queue</span><span class="p">.</span><span class="n">pop</span><span class="p">();</span>
    <span class="n">_lock</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span>
    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">WorkingQueue</span><span class="o">::</span><span class="n">product</span><span class="p">(</span><span class="kt">int</span> <span class="n">num</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">_lock</span><span class="p">.</span><span class="n">lock</span><span class="p">();</span>
    <span class="n">_queue</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">num</span><span class="p">);</span>
    <span class="n">_cond</span><span class="p">.</span><span class="n">notify</span><span class="p">();</span>
    <span class="n">_lock</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span>
<span class="p">}</span></code></pre></div>

<h3>ProducerThread.h</h3>

<div class="highlight"><pre><code class="c--"><span class="cm">/*</span>
<span class="cm"> * ProducerThread.h</span>
<span class="cm"> *</span>
<span class="cm"> *  Created on: Apr 15, 2014</span>
<span class="cm"> *      Author: liuwenyu</span>
<span class="cm"> */</span>

<span class="cp">#ifndef PRODUCERTHREAD_H_</span>
<span class="cp">#define PRODUCERTHREAD_H_</span>

<span class="cp">#include &lt;pthread.h&gt;</span>
<span class="cp">#include &quot;WorkingQueue.h&quot;</span>

<span class="k">class</span> <span class="nc">ProducerThread</span> <span class="p">{</span>
<span class="nl">public:</span>
    <span class="n">ProducerThread</span><span class="p">(</span><span class="n">WorkingQueue</span><span class="o">*</span> <span class="n">p_queue</span><span class="p">);</span>
    <span class="k">virtual</span> <span class="o">~</span><span class="n">ProducerThread</span><span class="p">();</span>
    <span class="kt">void</span> <span class="nf">start</span><span class="p">();</span>
    <span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">thread_func</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>
    <span class="kt">void</span> <span class="nf">run</span><span class="p">();</span>
    <span class="kt">void</span> <span class="nf">join</span><span class="p">();</span>

<span class="nl">private:</span>
    <span class="kt">pthread_t</span> <span class="n">_tid</span><span class="p">;</span>
    <span class="n">WorkingQueue</span><span class="o">*</span> <span class="n">_p_queue</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#endif </span><span class="cm">/* PRODUCERTHREAD_H_ */</span><span class="cp"></span></code></pre></div>

<h3>ProducerThread.cpp</h3>

<div class="highlight"><pre><code class="c--"><span class="cm">/*</span>
<span class="cm"> * ProducerThread.cpp</span>
<span class="cm"> *</span>
<span class="cm"> *  Created on: Apr 15, 2014</span>
<span class="cm"> *      Author: liuwenyu</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;ProducerThread.h&quot;</span>
<span class="cp">#include &lt;unistd.h&gt;</span>
<span class="cp">#include &lt;stdlib.h&gt;</span>
<span class="cp">#include &lt;iostream&gt;</span>

<span class="n">ProducerThread</span><span class="o">::</span><span class="n">ProducerThread</span><span class="p">(</span><span class="n">WorkingQueue</span><span class="o">*</span> <span class="n">p_queue</span><span class="p">)</span> <span class="o">:</span>
        <span class="n">_tid</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">_p_queue</span><span class="p">(</span><span class="n">p_queue</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// TODO Auto-generated constructor stub</span>
    <span class="n">srand</span><span class="p">(</span><span class="mi">10010</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">ProducerThread</span><span class="o">::~</span><span class="n">ProducerThread</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// TODO Auto-generated destructor stub</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="n">ProducerThread</span><span class="o">::</span><span class="n">start</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_tid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">thread_func</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="o">*</span><span class="n">ProducerThread</span><span class="o">::</span><span class="n">thread_func</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ProducerThread</span><span class="o">*</span> <span class="n">p_thread</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">ProducerThread</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
    <span class="n">p_thread</span><span class="o">-&gt;</span><span class="n">run</span><span class="p">();</span>
    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">ProducerThread</span><span class="o">::</span><span class="n">run</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">rand</span><span class="p">()</span><span class="o">%</span><span class="mi">1024</span><span class="p">;</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;product a number: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">tmp</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
        <span class="n">_p_queue</span><span class="o">-&gt;</span><span class="n">product</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">ProducerThread</span><span class="o">::</span><span class="n">join</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">pthread_join</span><span class="p">(</span><span class="n">_tid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span></code></pre></div>

<h3>ConsumerThread.h</h3>

<div class="highlight"><pre><code class="c--"><span class="cm">/*</span>
<span class="cm"> * ConsumerThread.h</span>
<span class="cm"> *</span>
<span class="cm"> *  Created on: Apr 15, 2014</span>
<span class="cm"> *      Author: liuwenyu</span>
<span class="cm"> */</span>

<span class="cp">#ifndef CONSUMERTHREAD_H_</span>
<span class="cp">#define CONSUMERTHREAD_H_</span>

<span class="cp">#include &lt;pthread.h&gt;</span>
<span class="cp">#include &quot;WorkingQueue.h&quot;</span>

<span class="k">class</span> <span class="nc">ConsumerThread</span> <span class="p">{</span>
<span class="nl">public:</span>
    <span class="n">ConsumerThread</span><span class="p">(</span><span class="n">WorkingQueue</span><span class="o">*</span> <span class="n">p_queue</span><span class="p">);</span>
    <span class="k">virtual</span> <span class="o">~</span><span class="n">ConsumerThread</span><span class="p">();</span>
    <span class="kt">void</span> <span class="nf">start</span><span class="p">();</span>
    <span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">thread_func</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>
    <span class="kt">void</span> <span class="nf">run</span><span class="p">();</span>
    <span class="kt">void</span> <span class="nf">join</span><span class="p">();</span>

<span class="nl">private:</span>
    <span class="kt">pthread_t</span> <span class="n">_tid</span><span class="p">;</span>
    <span class="n">WorkingQueue</span><span class="o">*</span> <span class="n">_p_queue</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#endif </span><span class="cm">/* CONSUMERTHREAD_H_ */</span><span class="cp"></span></code></pre></div>

<h3>ConsumerThread.cpp</h3>

<div class="highlight"><pre><code class="c--"><span class="cm">/*</span>
<span class="cm"> * ConsumerThread.cpp</span>
<span class="cm"> *</span>
<span class="cm"> *  Created on: Apr 15, 2014</span>
<span class="cm"> *      Author: liuwenyu</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;ConsumerThread.h&quot;</span>
<span class="cp">#include &lt;iostream&gt;</span>
<span class="cp">#include &lt;unistd.h&gt;</span>
<span class="cp">#include &lt;stdlib.h&gt;</span>


<span class="n">ConsumerThread</span><span class="o">::</span><span class="n">ConsumerThread</span><span class="p">(</span><span class="n">WorkingQueue</span><span class="o">*</span> <span class="n">p_queue</span><span class="p">)</span> <span class="o">:</span>
        <span class="n">_tid</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">_p_queue</span><span class="p">(</span><span class="n">p_queue</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// TODO Auto-generated constructor stub</span>
<span class="p">}</span>

<span class="n">ConsumerThread</span><span class="o">::~</span><span class="n">ConsumerThread</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// TODO Auto-generated destructor stub</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">ConsumerThread</span><span class="o">::</span><span class="n">start</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_tid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">thread_func</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="o">*</span><span class="n">ConsumerThread</span><span class="o">::</span><span class="n">thread_func</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ConsumerThread</span><span class="o">*</span> <span class="n">p_thread</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">ConsumerThread</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
    <span class="n">p_thread</span><span class="o">-&gt;</span><span class="n">run</span><span class="p">();</span>
    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">ConsumerThread</span><span class="o">::</span><span class="n">run</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">while</span><span class="p">(</span><span class="nb">true</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">_p_queue</span><span class="o">-&gt;</span><span class="n">consume</span><span class="p">();</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;get a number: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">ret</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">ConsumerThread</span><span class="o">::</span><span class="n">join</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">pthread_join</span><span class="p">(</span><span class="n">_tid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span></code></pre></div>

<h2>1.pthread<em>cond</em>wait如果不阻塞，什么也不做，如果阻塞：</h2>

<blockquote>
<ul>
<li>a)   释放锁</li>
<li>b)   使得线程睡眠，等待被唤醒</li>
<li>c)   重新抢占mutex</li>
</ul>
</blockquote>

<h2>2. 等待代码要用while循环：</h2>
<div class="highlight"><pre><code class="language-text" data-lang="text">while (Q.empty())
        pthread_cond_wait(&amp;cond, &amp;mutex);
防止pthread_cond_broadcast的干扰
</code></pre></div>
<h2>3. 线程安全的概念</h2>

<h2>4. 生产者消费者改进空间：</h2>

<blockquote>
<ul>
<li>继承</li>
<li>考虑缓冲区溢出（队列满）</li>
<li>再次封装成车间类</li>
</ul>
</blockquote>

<h2>任务：封装车间类</h2>

<blockquote>
<ul>
<li>把生产者、消费者和缓冲区队列组合成新的类</li>
<li>可以指定每种线程的个数</li>
<li>可以指定每种线程的频率（隔几秒种）</li>
</ul>
</blockquote>

<h2>5. 类的设计原则：</h2>

<blockquote>
<ul>
<li>先去考察系统中几个对象</li>
<li>功能应该放在哪里</li>
<li>应该尽可能封装细节，外部的用户只知道接口即可。</li>
<li>模块之间的独立性</li>
<li>对象之间的关系（类的成员用指针还是对象）</li>
</ul>
</blockquote>

<h2>总结</h2>

<h2>关于面向对象设计的一点思路</h2>

<blockquote>
<ul>
<li>如果一段代码重复使用多次，最好封装成一个函数</li>
<li>对外部完全隐藏，所谓封装好</li>
<li>外部使用一个封装好的类时，不应该接触其内部细节。</li>
</ul>
</blockquote>

<p><a href="www.baidu.com">1</a></p>

    </div>
    <hr>
    <div id="disqus_thread">
  <button type="button" name="liuwenyu" class="btn btn-default show-commend">显示评论</button>
</div>

  </div>
  <!-- 目录 -->
  <div id="content_table" style="position:fixed;right:20px;top:120px;display:none;">
    <div class="panel panel-success">
      <div class="panel-body" id="nav"></div>
    </div>
  </div>
</div>


          </div>
        </div>
      </div>
    </div>
  </div>
  <div style="position:fixed;right:20px;top:10px;">
  <button id="nav_btn" class="btn btn-lg" style="height:45px;width:45px;"><i class="fa fa-angle-left"></i></button>
</div>
<div style="position:fixed;right:20px;top:60px;">
  <button id="content_btn" class="btn btn-lg" style="height:45px;width:45px;"><i class="fa fa-angle-down"></i></button>
</div>
<script type="text/javascript" src="/public/js/jquery.js"></script>
<script type="text/javascript" src="/public/js/bootstrap.js"></script>
<script src="/public/js/jquery.pjax.js"></script>
<script src="/public/js/prettify/prettify.js"></script>
<script>
    $('a[href="#学习"]').tab('show');
</script>
<script src="/public/js/base.js"></script>
 
</body>
</html>
