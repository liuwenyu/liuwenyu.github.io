<!doctype html>
<html>
<head>
  <meta charset="utf-8">
<title>FTP文件服务器 项目 | 落枫的博客</title>
<meta name="author" content="">

  <meta name="keywords" content="linux">


<link rel="shortcut icon" href="/public/upload/gavatar/favicon.ico" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="/public/css/bootstrap.css">
<link rel="stylesheet" href="/public/css/font-awesome.css">
<link rel="stylesheet" href="/public/js/prettify/prettify.css">
<link rel="stylesheet" href="/public/css/base.css">
<!--<link href="/pages/atom.xml" rel="alternate" title="落枫的博客" type="application/atom+xml"> -->
</head>
<body>
  <div class="container">
    <div class="row">
      <div class="col-md-4 col-lg-4 col-sm-12 col-xs-12 aside visible-md visible-lg">
  <div class="row">
    <div class="col-md-3 col-xs-3 aside1">
      <br>
      <a class="pjaxlink" href="/"><img src="/public/upload/gavatar/gavatar.png" class="img-rounded avatar"></a>
      <br><br>
      <ul class="nav nav-pills nav-stacked">
        
          <li><a href="#学习" data-toggle="tab">学习</a></li>
        
          <li><a href="#技术学习" data-toggle="tab">技术学习</a></li>
        
        <li><a href="#tags" data-toggle="tab">标签</a></li>
        <!--        <li><a class="pjaxlink" href="/pages/about.html">关于</a></li>-->
      </ul>
      <div class="aside1_bottom">
        <!--
        <table class="table table-condensed">
          <tr>
            <td><a href="/pages/atom.xml" target="_blank"><i class="fa fa-rss fa-2x"></i></a></td>
            <td><a href="mailto:liuwenyu21@gmail.com"><i class="fa fa-envelope-o fa-2x"></i></a></td>
          </tr>
        </table>
      -->
        <!--
      <img src="" class="img-rounded weixin">
      -->
      </div>
    </div>
    <div class="col-md-9 col-xs-9 aside2">
      <div class="row">
        <div class="tab-content">
           
            <div class="tab-pane" id="学习">
              <div class="list-group">
                <h2 class="center">学习</h2>
                
                  <a href="/2014/06/16/%E9%93%BE%E8%A1%A8.html" class="list-group-item pjaxlink">二叉树 链表</a>
                
                  <a href="/2014/06/15/fork.html" class="list-group-item pjaxlink">多进程 fork</a>
                
                  <a href="/2014/06/14/sql.html" class="list-group-item pjaxlink">MySql</a>
                
                  <a href="/2014/06/13/%E6%8E%92%E5%BA%8F.html" class="list-group-item pjaxlink">排序 查找 键树 结构体</a>
                
                  <a href="/2014/06/10/%E9%87%8D%E8%BD%BD.html" class="list-group-item pjaxlink">重载 虚函数 动态绑定</a>
                
                  <a href="/2014/06/07/%E9%80%92%E5%BD%92.html" class="list-group-item pjaxlink">递归 宏定义 内联函数</a>
                
                  <a href="/2014/06/04/%E8%81%94%E5%90%88%E4%BD%93.html" class="list-group-item pjaxlink">联合体 大端小端 位域 指针引用</a>
                
                  <a href="/2014/06/02/volatile.html" class="list-group-item pjaxlink">全局变量 volatile</a>
                
                  <a href="/2014/05/30/const%E4%B8%8E%E6%8C%87%E9%92%88.html" class="list-group-item pjaxlink">const与指针 函数返回值 声明</a>
                
                  <a href="/2014/05/03/UDP%E6%9C%8D%E5%8A%A1%E5%99%A8-%E5%83%B5%E5%B0%B8%E8%BF%9B%E7%A8%8B.html" class="list-group-item pjaxlink">UDP服务器 僵尸进程</a>
                
                  <a href="/2014/05/02/%E6%80%BB%E7%BB%93.html" class="list-group-item pjaxlink">学习总结</a>
                
                  <a href="/2014/05/01/%E8%99%9A%E7%BB%A7%E6%89%BF.html" class="list-group-item pjaxlink">约瑟夫问题 虚继承</a>
                
                  <a href="/2014/04/30/%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0.html" class="list-group-item pjaxlink">构造函数</a>
                
                  <a href="/2014/04/25/%E7%BA%BF%E7%A8%8B%E6%B1%A0.html" class="list-group-item pjaxlink">内存 线程池</a>
                
                  <a href="/2014/04/24/c++.html" class="list-group-item pjaxlink">c++</a>
                
                  <a href="/2014/04/23/%E5%86%85%E5%AD%98.html" class="list-group-item pjaxlink">内存 复制控制</a>
                
                  <a href="/2014/04/22/%E7%BB%A7%E6%89%BF.html" class="list-group-item pjaxlink">继承 函数重载覆盖隐藏</a>
                
                  <a href="/2014/04/21/string.html" class="list-group-item pjaxlink">重载运算符-智能指针-String</a>
                
                  <a href="/2014/04/18/%E5%A4%8D%E5%88%B6%E6%8E%A7%E5%88%B6.html" class="list-group-item pjaxlink">复制控制</a>
                
                  <a href="/2014/04/17/map.html" class="list-group-item pjaxlink">Linux网络编程 map</a>
                
                  <a href="/2014/04/16/%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F.html" class="list-group-item pjaxlink">工厂模式</a>
                
                  <a href="/2014/04/15/UDP%E6%9C%8D%E5%8A%A1%E5%99%A8-%E7%94%9F%E4%BA%A7%E8%80%85.html" class="list-group-item pjaxlink">UDP服务器 生产者</a>
                
                  <a href="/2014/04/14/%E7%BA%BF%E7%A8%8B.html" class="list-group-item pjaxlink">线程</a>
                
                  <a href="/2014/04/11/%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F.html" class="list-group-item pjaxlink">设计模式 单例模式</a>
                
                  <a href="/2014/04/09/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%8E%E5%A4%9A%E8%BF%9B%E7%A8%8B%E7%9A%84%E6%AF%94%E8%BE%83.html" class="list-group-item pjaxlink">进程 线程</a>
                
                  <a href="/2014/04/04/Socket-TCP.html" class="list-group-item pjaxlink">Socket TCP</a>
                
                  <a href="/2014/04/03/linux(UDP).html" class="list-group-item pjaxlink">基于UDP的多人群聊</a>
                
                  <a href="/2014/04/02/Linux.html" class="list-group-item pjaxlink">Linux网络编程 socket UDP</a>
                
                  <a href="/2014/04/01/Linux.html" class="list-group-item pjaxlink">大端小端 ip转换</a>
                
                  <a href="/2014/03/31/pthread.html" class="list-group-item pjaxlink">pthread</a>
                
              </div>
            </div>
           
            <div class="tab-pane" id="技术学习">
              <div class="list-group">
                <h2 class="center">技术学习</h2>
                
                  <a href="/2014/06/19/%E5%9F%BA%E4%BA%8EHTTP%E5%8D%8F%E8%AE%AE%E7%9A%84%E7%9B%AE%E5%BD%95%E6%B5%8F%E8%A7%88%E5%92%8C%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E6%9C%8D%E5%8A%A1%E5%99%A8.html" class="list-group-item pjaxlink">FTP文件服务器 项目</a>
                
                  <a href="/2014/06/01/%E5%AD%A6%E4%B9%A0%E9%87%8D%E7%82%B9.html" class="list-group-item pjaxlink">学习方向与重点</a>
                
                  <a href="/2014/05/26/MiniSearchEngine%E6%80%BB%E7%BB%93.html" class="list-group-item pjaxlink">MiniSearchEngine总结</a>
                
                  <a href="/2014/05/24/minisearchengin.html" class="list-group-item pjaxlink">MiniSearchEngine 项目</a>
                
                  <a href="/2014/05/22/SpellCorrector.html" class="list-group-item pjaxlink">SpellCorrector 项目</a>
                
                  <a href="/2014/05/05/epoll%E8%AF%A6%E8%A7%A3.html" class="list-group-item pjaxlink">epoll</a>
                
                  <a href="/2014/05/02/mini%E6%90%9C%E7%B4%A2.html" class="list-group-item pjaxlink">mini搜索</a>
                
              </div>
            </div>
          
          <div class="tab-pane" id="tags">
            <div class="panel-group" id="accordion">
              <h2 class="center">标签</h2>
               
                <div class="panel panel-info">
                  <div class="panel-heading">
                    <h4 class="panel-title">
                      <a data-toggle="collapse" data-toggle="collapse" data-parent="#accordion" href="#linux">linux</a>
                      <span class="badge pull-right">35</span>
                    </h4>
                  </div>
                  <div id="linux" class="panel-collapse collapse">
                    
                      <a  href='/2014/06/19/%E5%9F%BA%E4%BA%8EHTTP%E5%8D%8F%E8%AE%AE%E7%9A%84%E7%9B%AE%E5%BD%95%E6%B5%8F%E8%A7%88%E5%92%8C%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E6%9C%8D%E5%8A%A1%E5%99%A8.html' class="list-group-item pjaxlink">
                        FTP文件服务器 项目
                      </a>
                    
                      <a  href='/2014/06/16/%E9%93%BE%E8%A1%A8.html' class="list-group-item pjaxlink">
                        二叉树 链表
                      </a>
                    
                      <a  href='/2014/06/15/fork.html' class="list-group-item pjaxlink">
                        多进程 fork
                      </a>
                    
                      <a  href='/2014/06/13/%E6%8E%92%E5%BA%8F.html' class="list-group-item pjaxlink">
                        排序 查找 键树 结构体
                      </a>
                    
                      <a  href='/2014/06/10/%E9%87%8D%E8%BD%BD.html' class="list-group-item pjaxlink">
                        重载 虚函数 动态绑定
                      </a>
                    
                      <a  href='/2014/06/07/%E9%80%92%E5%BD%92.html' class="list-group-item pjaxlink">
                        递归 宏定义 内联函数
                      </a>
                    
                      <a  href='/2014/06/04/%E8%81%94%E5%90%88%E4%BD%93.html' class="list-group-item pjaxlink">
                        联合体 大端小端 位域 指针引用
                      </a>
                    
                      <a  href='/2014/06/02/volatile.html' class="list-group-item pjaxlink">
                        全局变量 volatile
                      </a>
                    
                      <a  href='/2014/06/01/%E5%AD%A6%E4%B9%A0%E9%87%8D%E7%82%B9.html' class="list-group-item pjaxlink">
                        学习方向与重点
                      </a>
                    
                      <a  href='/2014/05/30/const%E4%B8%8E%E6%8C%87%E9%92%88.html' class="list-group-item pjaxlink">
                        const与指针 函数返回值 声明
                      </a>
                    
                      <a  href='/2014/05/26/MiniSearchEngine%E6%80%BB%E7%BB%93.html' class="list-group-item pjaxlink">
                        MiniSearchEngine总结
                      </a>
                    
                      <a  href='/2014/05/24/minisearchengin.html' class="list-group-item pjaxlink">
                        MiniSearchEngine 项目
                      </a>
                    
                      <a  href='/2014/05/22/SpellCorrector.html' class="list-group-item pjaxlink">
                        SpellCorrector 项目
                      </a>
                    
                      <a  href='/2014/05/05/epoll%E8%AF%A6%E8%A7%A3.html' class="list-group-item pjaxlink">
                        epoll
                      </a>
                    
                      <a  href='/2014/05/03/UDP%E6%9C%8D%E5%8A%A1%E5%99%A8-%E5%83%B5%E5%B0%B8%E8%BF%9B%E7%A8%8B.html' class="list-group-item pjaxlink">
                        UDP服务器 僵尸进程
                      </a>
                    
                      <a  href='/2014/05/02/%E6%80%BB%E7%BB%93.html' class="list-group-item pjaxlink">
                        学习总结
                      </a>
                    
                      <a  href='/2014/05/02/mini%E6%90%9C%E7%B4%A2.html' class="list-group-item pjaxlink">
                        mini搜索
                      </a>
                    
                      <a  href='/2014/05/01/%E8%99%9A%E7%BB%A7%E6%89%BF.html' class="list-group-item pjaxlink">
                        约瑟夫问题 虚继承
                      </a>
                    
                      <a  href='/2014/04/30/%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0.html' class="list-group-item pjaxlink">
                        构造函数
                      </a>
                    
                      <a  href='/2014/04/25/%E7%BA%BF%E7%A8%8B%E6%B1%A0.html' class="list-group-item pjaxlink">
                        内存 线程池
                      </a>
                    
                      <a  href='/2014/04/24/c++.html' class="list-group-item pjaxlink">
                        c++
                      </a>
                    
                      <a  href='/2014/04/23/%E5%86%85%E5%AD%98.html' class="list-group-item pjaxlink">
                        内存 复制控制
                      </a>
                    
                      <a  href='/2014/04/22/%E7%BB%A7%E6%89%BF.html' class="list-group-item pjaxlink">
                        继承 函数重载覆盖隐藏
                      </a>
                    
                      <a  href='/2014/04/21/string.html' class="list-group-item pjaxlink">
                        重载运算符-智能指针-String
                      </a>
                    
                      <a  href='/2014/04/18/%E5%A4%8D%E5%88%B6%E6%8E%A7%E5%88%B6.html' class="list-group-item pjaxlink">
                        复制控制
                      </a>
                    
                      <a  href='/2014/04/17/map.html' class="list-group-item pjaxlink">
                        Linux网络编程 map
                      </a>
                    
                      <a  href='/2014/04/16/%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F.html' class="list-group-item pjaxlink">
                        工厂模式
                      </a>
                    
                      <a  href='/2014/04/15/UDP%E6%9C%8D%E5%8A%A1%E5%99%A8-%E7%94%9F%E4%BA%A7%E8%80%85.html' class="list-group-item pjaxlink">
                        UDP服务器 生产者
                      </a>
                    
                      <a  href='/2014/04/14/%E7%BA%BF%E7%A8%8B.html' class="list-group-item pjaxlink">
                        线程
                      </a>
                    
                      <a  href='/2014/04/11/%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F.html' class="list-group-item pjaxlink">
                        设计模式 单例模式
                      </a>
                    
                      <a  href='/2014/04/04/Socket-TCP.html' class="list-group-item pjaxlink">
                        Socket TCP
                      </a>
                    
                      <a  href='/2014/04/03/linux(UDP).html' class="list-group-item pjaxlink">
                        基于UDP的多人群聊
                      </a>
                    
                      <a  href='/2014/04/02/Linux.html' class="list-group-item pjaxlink">
                        Linux网络编程 socket UDP
                      </a>
                    
                      <a  href='/2014/04/01/Linux.html' class="list-group-item pjaxlink">
                        大端小端 ip转换
                      </a>
                    
                      <a  href='/2014/03/31/pthread.html' class="list-group-item pjaxlink">
                        pthread
                      </a>
                    
                  </div>
                </div>
               
                <div class="panel panel-info">
                  <div class="panel-heading">
                    <h4 class="panel-title">
                      <a data-toggle="collapse" data-toggle="collapse" data-parent="#accordion" href="#总结">总结</a>
                      <span class="badge pull-right">1</span>
                    </h4>
                  </div>
                  <div id="总结" class="panel-collapse collapse">
                    
                      <a  href='/2014/04/09/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%8E%E5%A4%9A%E8%BF%9B%E7%A8%8B%E7%9A%84%E6%AF%94%E8%BE%83.html' class="list-group-item pjaxlink">
                        进程 线程
                      </a>
                    
                  </div>
                </div>
               
                <div class="panel panel-info">
                  <div class="panel-heading">
                    <h4 class="panel-title">
                      <a data-toggle="collapse" data-toggle="collapse" data-parent="#accordion" href="#MySql">MySql</a>
                      <span class="badge pull-right">1</span>
                    </h4>
                  </div>
                  <div id="MySql" class="panel-collapse collapse">
                    
                      <a  href='/2014/06/14/sql.html' class="list-group-item pjaxlink">
                        MySql
                      </a>
                    
                  </div>
                </div>
              
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

      <div class="col-md-8 col-lg-8 col-sm-12 col-xs-12 aside3">
        <div id="container">
          <div id="pjax">
            <div class="row">
  <div class="col-md-12 aside3-title">
    <br>
    <h2 id="#identifier">FTP文件服务器 项目</h2>
    2014年06月19日
  </div>
  <div class="col-md-12 aside3-content">
    <hr>
    <div id="content">
      <h2>Reference：</h2>

<blockquote>
<ul>
<li>HTTP协议详解
http://blog.csdn.net/gueter/article/details/1524447</li>
<li>深入理解HTTP协议
http://blog.sina.com.cn/s/blog_6fa4ebf401011vlb.html</li>
</ul>
</blockquote>

<ul>
<li>项目名称：基于TCP协议的FTP文件服务器（FileServer）<br></li>
<li>项目技术：Linux编程， C， TCP， HTTP， 多进程</li>
<li>项目说明：该项目是一个基于TCP协议与HTTP协议的文件服务器，用户可以通过浏览器来访问文件服务器页面，用户可按需进行进行文件下载.</li>
</ul>

<p>遇到的问题：
客户端获取文件或文件夹时，若文件名中含有空格<code>&#39; &#39;</code>，则发送给服务器的文件名实际上对应的是<code>&#39;%20&#39;</code>，如：</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">客户端点击页面上显示的文件名&quot;Ubuntu One&quot;
实际上服务器获取的URL文件名是&quot;Ubuntu%20One&quot;
</code></pre></div>
<p>原因： 
在网络编程中，如果URL参数中含有特殊字符，如空格 <code>&#39; &#39;</code> 、 <code>&#39;#&#39;</code> 等
可能导致服务器端无法获得正确的参数值。这些字符被转换为 <code>&#39;%&#39;+ ASCII码的两位16进制</code>表示，如空格的ASCII码是<code>32</code>，即16进制的<code>0x20</code>，因此空格被替换成<code>&#39;%20&#39;</code>。
服务器接收后需要将之转换。</p>

<p>运行过程：
用户使用浏览器访问文件服务器，服务器接收后，生成一个子进程来处理请求，通过分析客户端请求的URL读取文件或目录信息，并将处理结果通过HTTP发回客户端。</p>

<p>C语言
代码：</p>
<div class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#include &lt;stdarg.h&gt;</span>
<span class="cp">#include &lt;errno.h&gt;</span>
<span class="cp">#include &lt;stdio.h&gt;</span>
<span class="cp">#include &lt;fcntl.h&gt;</span>
<span class="cp">#include &lt;unistd.h&gt;</span>
<span class="cp">#include &lt;string.h&gt;</span>
<span class="cp">#include &lt;time.h&gt;</span>
<span class="cp">#include &lt;sys/types.h&gt;</span>
<span class="cp">#include &lt;sys/stat.h&gt;</span>
<span class="cp">#include &lt;sys/socket.h&gt;</span>
<span class="cp">#include &lt;netinet/in.h&gt;</span>
<span class="cp">#include &lt;arpa/inet.h&gt;</span>
<span class="cp">#include &lt;dirent.h&gt;</span>
<span class="cp">#include &lt;errno.h&gt;</span>
<span class="cp">#include &lt;resolv.h&gt;</span>
<span class="cp">#include &lt;stdlib.h&gt;</span>
<span class="cp">#include &lt;signal.h&gt;</span>
<span class="cp">#include &lt;getopt.h&gt;</span>

<span class="cp">#define DEFAULTIP &quot;127.0.0.1&quot;</span>
<span class="cp">#define DEFAULTPORT &quot;80&quot;</span>
<span class="cp">#define DEFAULTBACK &quot;10&quot;</span>
<span class="cp">#define DEFAULTDIR &quot;/home&quot;</span>
<span class="cp">#define DEFAULTLOG &quot;/tmp/das-server.log&quot;</span>

<span class="kt">void</span> <span class="nf">prterrmsg</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">);</span>
<span class="cp">#define prterrmsg(msg) { perror(msg); abort(); }</span>
<span class="kt">void</span> <span class="nf">wrterrmsg</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">);</span>
<span class="cp">#define wrterrmsg(msg) { fputs(msg, logfp); fputs(strerror(errno), logfp);fflush(logfp); abort(); }</span>
<span class="kt">void</span> <span class="nf">prtinfomsg</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">);</span>
<span class="cp">#define prtinfomsg(msg) { fputs(msg, stdout);  }</span>
<span class="kt">void</span> <span class="nf">wrtinfomsg</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">);</span>
<span class="cp">#define wrtinfomsg(msg) { fputs(msg, logfp); fflush(logfp);}</span>
<span class="cp">#define MAXBUF 1024</span>
<span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="n">MAXBUF</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
<span class="kt">char</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">char</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">char</span> <span class="o">*</span><span class="n">back</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">char</span> <span class="o">*</span><span class="n">dirroot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">char</span> <span class="o">*</span><span class="n">logdir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">daemon_y_n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">FILE</span> <span class="o">*</span><span class="n">logfp</span><span class="p">;</span>

<span class="cp">#define MAXPATH 150</span>

<span class="cm">/*---------------------------------------- *</span>
<span class="cm"> * --- dir_up - - -  </span>
<span class="cm"> * 查找dirpath所指目录的上一级目录</span>
<span class="cm"> *---------------------------------------- */</span>

<span class="kt">char</span> <span class="o">*</span><span class="nf">dir_up</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">dirpath</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">static</span> <span class="kt">char</span> <span class="n">Path</span><span class="p">[</span><span class="n">MAXPATH</span><span class="p">];</span>
    <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
    <span class="n">strcpy</span><span class="p">(</span><span class="n">Path</span><span class="p">,</span> <span class="n">dirpath</span><span class="p">);</span>
    <span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">Path</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">Path</span><span class="p">[</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;/&#39;</span><span class="p">)</span>
        <span class="n">len</span><span class="o">--</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">Path</span><span class="p">[</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;/&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">len</span><span class="o">--</span><span class="p">;</span>
    <span class="n">Path</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">Path</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------ *--- AllocateMemory - 分配空间并把d所指的内容复制</span>
<span class="cm"> *------------------------------------------------------ */</span>
<span class="kt">void</span> <span class="nf">AllocateMemory</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">l</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">l</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">bzero</span><span class="p">(</span><span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="n">l</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/************关于本文档********************************************</span>
<span class="cm"> *filename: das-server.c</span>
<span class="cm"> *purpose: 这是在Linux下用C语言写的目录访问服务器，支持目录浏览和文件下载</span>
<span class="cm"> *wrote by: zhoulifa(zhoulifa@163.com) 周立发(http://zhoulifa.bokee.com) </span>
<span class="cm"> * Linux爱好者 Linux知识传播者 SOHO族 开发者 最擅长C语言</span>
<span class="cm"> *date time:2007-01-26 19:32</span>
<span class="cm"> *Note: 任何人可以任意复制代码并运用这些文档，当然包括你的商业用途</span>
<span class="cm"> * 但请遵循GPL</span>
<span class="cm"> *Thanks to: Google.com</span>
<span class="cm"> *Hope:希望越来越多的人贡献自己的力量，为科学技术发展出力</span>
<span class="cm"> * 科技站在巨人的肩膀上进步更快！感谢有开源前辈的贡献！</span>
<span class="cm"> *********************************************************************/</span>

<span class="cm">/*------------------------------------------------------ </span>
<span class="cm"> *--- GiveResponse - 把Path所指的内容发送到client_sock去</span>
<span class="cm"> *-------------------如果Path是一个目录，则列出目录内容</span>
<span class="cm"> *-------------------如果Path是一个文件，则下载文件</span>
<span class="cm"> *------------------------------------------------------ */</span>

<span class="kt">void</span> <span class="nf">GiveResponse</span><span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span> <span class="n">client_sock</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">Path</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">dirent</span> <span class="o">*</span><span class="n">dirent</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">stat</span> <span class="n">info</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">Filename</span><span class="p">[</span><span class="n">MAXPATH</span><span class="p">];</span>
    <span class="kt">DIR</span> <span class="o">*</span><span class="n">dir</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">realPath</span><span class="p">,</span> <span class="o">*</span><span class="n">realFilename</span><span class="p">,</span> <span class="o">*</span><span class="n">nport</span><span class="p">;</span>
    <span class="cm">/* 获得实际工作目录或文件 */</span>
    <span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">dirroot</span><span class="p">)</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">Path</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">realPath</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">bzero</span><span class="p">(</span><span class="n">realPath</span><span class="p">,</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">sprintf</span><span class="p">(</span><span class="n">realPath</span><span class="p">,</span> <span class="s">&quot;%s/%s&quot;</span><span class="p">,</span> <span class="n">dirroot</span><span class="p">,</span> <span class="n">Path</span><span class="p">);</span>
    <span class="cm">/* 获得实际工作端口 */</span>
    <span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">nport</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">bzero</span><span class="p">(</span><span class="n">nport</span><span class="p">,</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="c1">//#160;   </span>
    <span class="n">sprintf</span><span class="p">(</span><span class="n">nport</span><span class="p">,</span> <span class="s">&quot;:%s&quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
    <span class="cm">/* 获得实际工作目录或文件的信息以判断是文件还是目录 */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">stat</span><span class="p">(</span><span class="n">realPath</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">client_sock</span><span class="p">,</span>
                <span class="s">&quot;HTTP/1.1 200 OK</span><span class="se">\r\n</span><span class="s">Server: DAS by ZhouLifa</span><span class="se">\r\n</span><span class="s">Connection: close</span><span class="se">\r\n\r\n</span><span class="s">&lt;html&gt;&lt;head&gt;&lt;meta http-equiv=</span><span class="se">\&quot;</span><span class="s">Content-Type</span><span class="se">\&quot;</span><span class="s"> content=</span><span class="se">\&quot;</span><span class="s">text/html; charset=utf-8</span><span class="se">\&quot;</span><span class="s"> /&gt;&lt;title&gt;%d - %s&lt;/title&gt;&lt;/head&gt;&quot;</span>
                <span class="s">&quot;&lt;body&gt;&lt;font size=+4&gt;Linux 下目录访问服务器&lt;/font&gt;&lt;br&gt;&lt;hr width=</span><span class="se">\&quot;</span><span class="s">100%%</span><span class="se">\&quot;</span><span class="s">&gt;&lt;br&gt;&lt;center&gt;&quot;</span>
                <span class="s">&quot;&lt;table border cols=3 width=</span><span class="se">\&quot;</span><span class="s">100%%</span><span class="se">\&quot;</span><span class="s">&gt;&quot;</span><span class="p">,</span> <span class="n">errno</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">client_sock</span><span class="p">,</span> <span class="s">&quot;&lt;/table&gt;&lt;font color=</span><span class="se">\&quot;</span><span class="s">CC0000</span><span class="se">\&quot;</span><span class="s"> size=+2&gt;请向管理员咨询为何出现如下错误提示</span><span class="se">\n</span><span class="s">%s %s&lt;/font&gt;&lt;/body&gt;&lt;/html&gt;&quot;</span><span class="p">,</span> <span class="n">Path</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
        <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* 处理浏览文件请求，即下载文件 */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">S_ISREG</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">st_mode</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">realPath</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
        <span class="n">len</span> <span class="o">=</span> <span class="n">lseek</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SEEK_END</span><span class="p">);</span>
        <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">malloc</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
        <span class="n">bzero</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
        <span class="n">lseek</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">);</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
        <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">client_sock</span><span class="p">,</span>
                <span class="s">&quot;HTTP/1.1 200 OK</span><span class="se">\r\n</span><span class="s">Server: DAS by ZhouLifa</span><span class="se">\r\n</span><span class="s">Connection: keep-alive</span><span class="se">\r\n</span><span class="s">Content-type: application/*</span><span class="se">\r\n</span><span class="s">Content-Length:%d</span><span class="se">\r\n\r\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">len</span><span class="p">);</span>
        <span class="n">fwrite</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">client_sock</span><span class="p">);</span>
        <span class="n">free</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">st_mode</span><span class="p">))</span> <span class="p">{</span>
            <span class="cm">/* 处理浏览目录请求 */</span>
            <span class="n">dir</span> <span class="o">=</span> <span class="n">opendir</span><span class="p">(</span><span class="n">realPath</span><span class="p">);</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">client_sock</span><span class="p">,</span> 
                <span class="s">&quot;HTTP/1.1 200 OK</span><span class="se">\r\n</span><span class="s">Server: DAS by ZhouLifa</span><span class="se">\r\n</span><span class="s">Connection: close</span><span class="se">\r\n\r\n</span><span class="s">&lt;html&gt;&lt;head&gt;&lt;head&gt;&lt;meta http-equiv=</span><span class="se">\&quot;</span><span class="s">Content-Type</span><span class="se">\&quot;</span><span class="s"> content=</span><span class="se">\&quot;</span><span class="s">text/html; charset=utf-8</span><span class="se">\&quot;</span><span class="s"> /&gt;&lt;title&gt;%s&lt;/title&gt;&lt;/head&gt;&quot;</span> 
                <span class="s">&quot;&lt;body&gt;&lt;font size=+4&gt;Linux 下目录访问服务器&lt;/font&gt;&lt;br&gt;&lt;hr width=</span><span class="se">\&quot;</span><span class="s">100%%</span><span class="se">\&quot;</span><span class="s">&gt;&lt;br&gt;&lt;center&gt;&quot;</span>
                <span class="s">&quot;&lt;table border cols=3 width=</span><span class="se">\&quot;</span><span class="s">100%%</span><span class="se">\&quot;</span><span class="s">&gt;&quot;</span><span class="p">,</span> <span class="n">Path</span><span class="p">);</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">client_sock</span><span class="p">,</span>
                <span class="s">&quot;&lt;caption&gt;&lt;font size=+3&gt;目录 %s&lt;/font&gt;&lt;/caption&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                <span class="n">Path</span><span class="p">);</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">client_sock</span><span class="p">,</span>
                <span class="s">&quot;&lt;tr&gt;&lt;td&gt;名称&lt;/td&gt;&lt;td&gt;大小&lt;/td&gt;&lt;td&gt;修改时间&lt;/td&gt;&lt;/tr&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">dir</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">fprintf</span><span class="p">(</span><span class="n">client_sock</span><span class="p">,</span>
                    <span class="s">&quot;&lt;/table&gt;&lt;font color=</span><span class="se">\&quot;</span><span class="s">CC0000</span><span class="se">\&quot;</span><span class="s"> size=+2&gt;&quot;</span>
                    <span class="s">&quot;%s&lt;/font&gt;&lt;/body&gt;&lt;/html&gt;&quot;</span><span class="p">,</span>
                    <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="cm">/* 读取目录里的所有内容 */</span>
        <span class="k">while</span> <span class="p">((</span><span class="n">dirent</span> <span class="o">=</span> <span class="n">readdir</span><span class="p">(</span><span class="n">dir</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">Path</span><span class="p">,</span> <span class="s">&quot;/&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">sprintf</span><span class="p">(</span><span class="n">Filename</span><span class="p">,</span> <span class="s">&quot;/%s&quot;</span><span class="p">,</span> <span class="n">dirent</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">);</span>
            <span class="k">else</span>
                <span class="n">sprintf</span><span class="p">(</span><span class="n">Filename</span><span class="p">,</span> <span class="s">&quot;%s/%s&quot;</span><span class="p">,</span> <span class="n">Path</span><span class="p">,</span> <span class="n">dirent</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">);</span>

            <span class="n">fprintf</span><span class="p">(</span><span class="n">client_sock</span><span class="p">,</span> <span class="s">&quot;&lt;tr&gt;&quot;</span><span class="p">);</span>
            <span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">dirroot</span><span class="p">)</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">Filename</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
            <span class="n">realFilename</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
            <span class="n">bzero</span><span class="p">(</span><span class="n">realFilename</span><span class="p">,</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
            <span class="n">sprintf</span><span class="p">(</span><span class="n">realFilename</span><span class="p">,</span> <span class="s">&quot;%s/%s&quot;</span><span class="p">,</span> <span class="n">dirroot</span><span class="p">,</span> <span class="n">Filename</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">stat</span><span class="p">(</span><span class="n">realFilename</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">dirent</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">,</span> <span class="s">&quot;..&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">fprintf</span><span class="p">(</span><span class="n">client_sock</span><span class="p">,</span>
                            <span class="s">&quot;&lt;td&gt;&lt;a href=</span><span class="se">\&quot;</span><span class="s">http://%s%s%s</span><span class="se">\&quot;</span><span class="s">&gt;(parent)&lt;/a&gt;&lt;/td&gt;&quot;</span><span class="p">,</span>
                            <span class="n">host</span><span class="p">,</span> <span class="n">atoi</span><span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">==</span> <span class="mi">80</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="n">nport</span><span class="p">,</span>
                            <span class="n">dir_up</span><span class="p">(</span><span class="n">Path</span><span class="p">));</span>
                <span class="k">else</span>
                    <span class="n">fprintf</span><span class="p">(</span><span class="n">client_sock</span><span class="p">,</span>
                            <span class="s">&quot;&lt;td&gt;&lt;a href=</span><span class="se">\&quot;</span><span class="s">http://%s%s%s</span><span class="se">\&quot;</span><span class="s">&gt;%s&lt;/a&gt;&lt;/td&gt;&quot;</span><span class="p">,</span>
                            <span class="n">host</span><span class="p">,</span> <span class="n">atoi</span><span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">==</span> <span class="mi">80</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="n">nport</span><span class="p">,</span> <span class="n">Filename</span><span class="p">,</span>
                            <span class="n">dirent</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">);</span>
<span class="c1">//#160;              </span>
                <span class="k">if</span> <span class="p">(</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">st_mode</span><span class="p">))</span>
                <span class="n">fprintf</span><span class="p">(</span><span class="n">client_sock</span><span class="p">,</span> <span class="s">&quot;&lt;td&gt;目录&lt;/td&gt;&quot;</span><span class="p">);</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">S_ISREG</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">st_mode</span><span class="p">))</span>
                    <span class="n">fprintf</span><span class="p">(</span><span class="n">client_sock</span><span class="p">,</span> <span class="s">&quot;&lt;td&gt;%d&lt;/td&gt;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">info</span><span class="p">.</span><span class="n">st_size</span><span class="p">);</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">S_ISLNK</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">st_mode</span><span class="p">))</span>
                    <span class="n">fprintf</span><span class="p">(</span><span class="n">client_sock</span><span class="p">,</span> <span class="s">&quot;&lt;td&gt;链接&lt;/td&gt;&quot;</span><span class="p">);</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">S_ISCHR</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">st_mode</span><span class="p">))</span>
                    <span class="n">fprintf</span><span class="p">(</span><span class="n">client_sock</span><span class="p">,</span> <span class="s">&quot;&lt;td&gt;字符设备&lt;/td&gt;&quot;</span><span class="p">);</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">S_ISBLK</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">st_mode</span><span class="p">))</span>
                    <span class="n">fprintf</span><span class="p">(</span><span class="n">client_sock</span><span class="p">,</span> <span class="s">&quot;&lt;td&gt;块设备&lt;/td&gt;&quot;</span><span class="p">);</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">S_ISFIFO</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">st_mode</span><span class="p">))</span>
                    <span class="n">fprintf</span><span class="p">(</span><span class="n">client_sock</span><span class="p">,</span> <span class="s">&quot;&lt;td&gt;FIFO&lt;/td&gt;&quot;</span><span class="p">);</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">S_ISSOCK</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">st_mode</span><span class="p">))</span>
                    <span class="n">fprintf</span><span class="p">(</span><span class="n">client_sock</span><span class="p">,</span> <span class="s">&quot;&lt;td&gt;Socket&lt;/td&gt;&quot;</span><span class="p">);</span>
                <span class="k">else</span>
                    <span class="n">fprintf</span><span class="p">(</span><span class="n">client_sock</span><span class="p">,</span> <span class="s">&quot;&lt;td&gt;(未知)&lt;/td&gt;&quot;</span><span class="p">);</span>
                <span class="n">fprintf</span><span class="p">(</span><span class="n">client_sock</span><span class="p">,</span> <span class="s">&quot;&lt;td&gt;%s&lt;/td&gt;&quot;</span><span class="p">,</span> <span class="n">ctime</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">.</span><span class="n">st_ctime</span><span class="p">));</span>
            <span class="p">}</span>
            <span class="n">fprintf</span><span class="p">(</span><span class="n">client_sock</span><span class="p">,</span> <span class="s">&quot;&lt;/tr&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="n">free</span><span class="p">(</span><span class="n">realFilename</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">client_sock</span><span class="p">,</span> <span class="s">&quot;&lt;/table&gt;&lt;/center&gt;&lt;/body&gt;&lt;/html&gt;&quot;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="cm">/* 既非常规文件又非目录，禁止访问 */</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">client_sock</span><span class="p">,</span>
                <span class="s">&quot;HTTP/1.1 200 OK</span><span class="se">\r\n</span><span class="s">Server: DAS by ZhouLifa</span><span class="se">\r\n</span><span class="s">Connection: &quot;</span>
                <span class="s">&quot;close</span><span class="se">\r\n\r\n</span><span class="s">&lt;html&gt;&lt;head&gt;&lt;head&gt;&lt;meta http-equiv=</span><span class="se">\&quot;</span><span class="s">Content-Type</span><span class="se">\&quot;</span><span class="s"> content=</span><span class="se">\&quot;</span><span class="s">text/html; charset=utf-8</span><span class="se">\&quot;</span><span class="s"> /&gt;&lt;title&gt;permission denied&lt;/title&gt;&lt;/head&gt;&quot;</span>
                <span class="s">&quot;&lt;body&gt;&lt;font size=+4&gt;Linux 下目录访问服务器&lt;/font&gt;&lt;br&gt;&lt;hr &quot;</span>
                <span class="s">&quot;width=</span><span class="se">\&quot;</span><span class="s">100%%</span><span class="se">\&quot;</span><span class="s">&gt;&lt;br&gt;&lt;center&gt;&quot;</span>
                <span class="s">&quot;&lt;table border cols=3 width=</span><span class="se">\&quot;</span><span class="s">100%%</span><span class="se">\&quot;</span><span class="s">&gt;&quot;</span><span class="p">);</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">client_sock</span><span class="p">,</span>
                <span class="s">&quot;&lt;/table&gt;&lt;font color=</span><span class="se">\&quot;</span><span class="s">CC0000</span><span class="se">\&quot;</span><span class="s"> size=+2&gt;你访问的资源&#39;%s&#39;被禁止访问，请联系管理员解决！&lt;/font&gt;&lt;/body&gt;&lt;/html&amp; gt;&quot;</span><span class="p">,</span>
                <span class="n">Path</span><span class="p">);</span>
    <span class="p">}</span>
<span class="nl">out:</span>
    <span class="n">free</span><span class="p">(</span><span class="n">realPath</span><span class="p">);</span>
    <span class="n">free</span><span class="p">(</span><span class="n">nport</span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/*------------------------------------------------------ *--- getoption - 分析取出程序的参数</span>
<span class="cm"> *------------------------------------------------------ */</span>
<span class="kt">void</span> <span class="nf">getoption</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>   <span class="p">{</span>
    <span class="kt">int</span> <span class="n">c</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">opterr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">option_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">static</span> <span class="k">struct</span> <span class="n">option</span> <span class="n">long_options</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="p">{</span><span class="s">&quot;host&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
            <span class="p">{</span><span class="s">&quot;port&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
            <span class="p">{</span><span class="s">&quot;back&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
            <span class="p">{</span><span class="s">&quot;dir&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
            <span class="p">{</span><span class="s">&quot;log&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
            <span class="p">{</span><span class="s">&quot;daemon&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
            <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">}</span>
        <span class="p">};</span>
        <span class="cm">/* 本程序支持如一些参数：</span>
<span class="cm">         * --host IP地址 或者 -H IP地址</span>
<span class="cm">         * --port 端口 或者 -P 端口</span>
<span class="cm">         * --back 监听数量 或者 -B 监听数量</span>
<span class="cm">         * --dir 网站根目录 或者 -D 网站根目录</span>
<span class="cm">         * --log 日志存放路径 或者 -L 日志存放路径</span>
<span class="cm">         * --daemon 使程序进入后台运行模式</span>
<span class="cm">         */</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">getopt_long</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="s">&quot;H:P:B:D:L&quot;</span><span class="p">,</span>
                <span class="n">long_options</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">option_index</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;?&#39;</span><span class="p">)</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">optarg</span><span class="p">)</span>      
            <span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">optarg</span><span class="p">);</span>
        <span class="k">else</span>  
            <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">c</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">long_options</span><span class="p">[</span><span class="n">option_index</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;host&quot;</span><span class="p">)))</span>
                <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;H&#39;</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">host</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">c</span>
                    <span class="o">&amp;&amp;</span>
                    <span class="o">!</span><span class="p">(</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">long_options</span><span class="p">[</span><span class="n">option_index</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;port&quot;</span><span class="p">)))</span>
                <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;P&#39;</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">port</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">c</span>
                    <span class="o">&amp;&amp;</span>
                    <span class="o">!</span><span class="p">(</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">long_options</span><span class="p">[</span><span class="n">option_index</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;back&quot;</span><span class="p">)))</span>
                <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;B&#39;</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">back</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">c</span>
                    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">long_options</span><span class="p">[</span><span class="n">option_index</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;dir&quot;</span><span class="p">)))</span>
                <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;D&#39;</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">dirroot</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">c</span>
                    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">long_options</span><span class="p">[</span><span class="n">option_index</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;log&quot;</span><span class="p">)))</span>
                <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;L&#39;</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">logdir</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">c</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">strcasecmp</span>
                        <span class="p">(</span><span class="n">long_options</span><span class="p">[</span><span class="n">option_index</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;daemon&quot;</span><span class="p">))))</span> <span class="p">{</span>
            <span class="n">daemon_y_n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="n">bzero</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">optarg</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">addr</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">sock_fd</span><span class="p">;</span> 
    <span class="kt">socklen_t</span> <span class="n">addrlen</span><span class="p">;</span>
    <span class="cm">/* 获得程序工作的参数，如 IP 、端口、监听数、网页根目录、目录存放位置等 */</span>
    <span class="n">getoption</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">addrlen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">DEFAULTIP</span><span class="p">);</span>
        <span class="n">AllocateMemory</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="p">,</span> <span class="n">addrlen</span><span class="p">,</span> <span class="n">strdup</span><span class="p">(</span><span class="n">DEFAULTIP</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">addrlen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">DEFAULTPORT</span><span class="p">);</span>
        <span class="n">AllocateMemory</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="p">,</span> <span class="n">addrlen</span><span class="p">,</span> <span class="n">strdup</span><span class="p">(</span><span class="n">DEFAULTPORT</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">back</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">addrlen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">DEFAULTBACK</span><span class="p">);</span>
        <span class="n">AllocateMemory</span><span class="p">(</span><span class="o">&amp;</span><span class="n">back</span><span class="p">,</span> <span class="n">addrlen</span><span class="p">,</span> <span class="n">strdup</span><span class="p">(</span><span class="n">DEFAULTBACK</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dirroot</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">addrlen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">DEFAULTDIR</span><span class="p">);</span>
        <span class="n">AllocateMemory</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dirroot</span><span class="p">,</span> <span class="n">addrlen</span><span class="p">,</span> <span class="n">strdup</span><span class="p">(</span><span class="n">DEFAULTDIR</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">logdir</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">addrlen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">DEFAULTLOG</span><span class="p">);</span>
        <span class="n">AllocateMemory</span><span class="p">(</span><span class="o">&amp;</span><span class="n">logdir</span><span class="p">,</span> <span class="n">addrlen</span><span class="p">,</span> <span class="n">strdup</span><span class="p">(</span><span class="n">DEFAULTLOG</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="n">printf</span>
        <span class="p">(</span><span class="s">&quot;host=%s port=%s back=%s dirroot=%s logdir=%s %s是后台工作模式(进程ID：%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
         <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">back</span><span class="p">,</span> <span class="n">dirroot</span><span class="p">,</span> <span class="n">logdir</span><span class="p">,</span> <span class="n">daemon_y_n</span><span class="o">?</span><span class="s">&quot;&quot;</span><span class="o">:</span> <span class="s">&quot;不&quot;</span><span class="p">,</span> <span class="n">getpid</span><span class="p">());</span>
    <span class="cm">/* fork() 两次处于后台工作模式下 */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">daemon_y_n</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">fork</span><span class="p">())</span>
            <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">fork</span><span class="p">())</span>
            <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="n">close</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">close</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">close</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
        <span class="n">logfp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">logdir</span><span class="p">,</span> <span class="s">&quot;a+&quot;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">logfp</span><span class="p">)</span>
            <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="cm">/* 处理子进程退出以免产生僵尸进程 */</span>
    <span class="n">signal</span><span class="p">(</span><span class="n">SIGCHLD</span><span class="p">,</span> <span class="n">SIG_IGN</span><span class="p">);</span>
    <span class="cm">/* 创建 socket */</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">sock_fd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">PF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">daemon_y_n</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">prterrmsg</span><span class="p">(</span><span class="s">&quot;socket()&quot;</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">wrterrmsg</span><span class="p">(</span><span class="s">&quot;socket()&quot;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="cm">/* 设置端口快速重用 */</span>
    <span class="n">addrlen</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">setsockopt</span><span class="p">(</span><span class="n">sock_fd</span><span class="p">,</span> <span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addrlen</span><span class="p">,</span>
            <span class="k">sizeof</span><span class="p">(</span><span class="n">addrlen</span><span class="p">));</span>
    <span class="n">addr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
    <span class="n">addr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">atoi</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>
    <span class="n">addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">inet_addr</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
    <span class="n">addrlen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span><span class="p">);</span>
    <span class="cm">/* 绑定地址、端口等信息 */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">bind</span><span class="p">(</span><span class="n">sock_fd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="n">addrlen</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">daemon_y_n</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">prterrmsg</span><span class="p">(</span><span class="s">&quot;bind()&quot;</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">wrterrmsg</span><span class="p">(</span><span class="s">&quot;bind()&quot;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="cm">/* 开启临听 */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">listen</span><span class="p">(</span><span class="n">sock_fd</span><span class="p">,</span> <span class="n">atoi</span><span class="p">(</span><span class="n">back</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">daemon_y_n</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">prterrmsg</span><span class="p">(</span><span class="s">&quot;listen()&quot;</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">wrterrmsg</span><span class="p">(</span><span class="s">&quot;listen()&quot;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">new_fd</span><span class="p">;</span>
        <span class="n">addrlen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span><span class="p">);</span>
        <span class="cm">/* 接受新连接请求 */</span>
        <span class="n">new_fd</span> <span class="o">=</span> <span class="n">accept</span><span class="p">(</span><span class="n">sock_fd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addrlen</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">new_fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">daemon_y_n</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">prterrmsg</span><span class="p">(</span><span class="s">&quot;accept()&quot;</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">wrterrmsg</span><span class="p">(</span><span class="s">&quot;accept()&quot;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">bzero</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">MAXBUF</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
        <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;连接来自于: %s:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                <span class="n">inet_ntoa</span><span class="p">(</span><span class="n">addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">),</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">addr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">daemon_y_n</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">prtinfomsg</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">wrtinfomsg</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="cm">/* 产生一个子进程去处理请求，当前进程继续等待新的连接到来 */</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fork</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">bzero</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">MAXBUF</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">len</span> <span class="o">=</span> <span class="n">recv</span><span class="p">(</span><span class="n">new_fd</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">MAXBUF</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="kt">FILE</span> <span class="o">*</span><span class="n">ClientFP</span> <span class="o">=</span> <span class="n">fdopen</span><span class="p">(</span><span class="n">new_fd</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ClientFP</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">daemon_y_n</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">prterrmsg</span><span class="p">(</span><span class="s">&quot;fdopen()&quot;</span><span class="p">);</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="n">prterrmsg</span><span class="p">(</span><span class="s">&quot;fdopen()&quot;</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="kt">char</span> <span class="n">Req</span><span class="p">[</span><span class="n">MAXPATH</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
                    <span class="n">sscanf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;GET %s HTTP&quot;</span><span class="p">,</span> <span class="n">Req</span><span class="p">);</span>
                    <span class="n">bzero</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">MAXBUF</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
                    <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;请求取文件: </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Req</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">daemon_y_n</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">prtinfomsg</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="n">wrtinfomsg</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="cm">/* 处理用户请求 */</span>
                    <span class="n">GiveResponse</span><span class="p">(</span><span class="n">ClientFP</span><span class="p">,</span> <span class="n">Req</span><span class="p">);</span>
                    <span class="n">fclose</span><span class="p">(</span><span class="n">ClientFP</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">close</span><span class="p">(</span><span class="n">new_fd</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">close</span><span class="p">(</span><span class="n">sock_fd</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
    </div>
    <hr>
    <div id="disqus_thread">
  <button type="button" name="liuwenyu" class="btn btn-default show-commend">显示评论</button>
</div>

  </div>
  <!-- 目录 -->
  <div id="content_table" style="position:fixed;right:20px;top:120px;display:none;">
    <div class="panel panel-success">
      <div class="panel-body" id="nav"></div>
    </div>
  </div>
</div>


          </div>
        </div>
      </div>
    </div>
  </div>
  <div style="position:fixed;right:20px;top:10px;">
  <button id="nav_btn" class="btn btn-lg" style="height:45px;width:45px;"><i class="fa fa-angle-left"></i></button>
</div>
<div style="position:fixed;right:20px;top:60px;">
  <button id="content_btn" class="btn btn-lg" style="height:45px;width:45px;"><i class="fa fa-angle-down"></i></button>
</div>
<script type="text/javascript" src="/public/js/jquery.js"></script>
<script type="text/javascript" src="/public/js/bootstrap.js"></script>
<script src="/public/js/jquery.pjax.js"></script>
<script src="/public/js/prettify/prettify.js"></script>
<script>
    $('a[href="#技术学习"]').tab('show');
</script>
<script src="/public/js/base.js"></script>
 
</body>
</html>
